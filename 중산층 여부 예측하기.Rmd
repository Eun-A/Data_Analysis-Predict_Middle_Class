---
title: "R 분류분석 : 중산층 여부 예측하기"
output: rmarkdown::github_document
---
2017 . 10 . 02 

'따라하며 배우는 데이터과학'책의 8장 내용을 정리한 것입니다.

UCI 머신러닝 예제 데이터 아카이브의 'Adult'데이터를 사용하였다.(https://goo.gl/yVK0qq)

13개의 설명변수에 근거해서 연소득이 $50k가 넘는지(중산층 여부) 예측하기

### - 순서
#### 1. 데이터 로드와 데이터 구조 파악하기
#### 2. 훈련, 검증, 테스트세트로 분할
#### 3. 시각화로 데이터 탐색하기 EDA
#####  1) 나이(age)와 중산층 여부(wage)의 관계
#####  2) 인종, 성별, 나이 세 변수와 중산층 여부의 관계
#####  3) 총 교육기간과 중산층 여부의 관계
#### 4. 모형적합 - 로지스틱 회귀
#### 5. glm로지스틱회귀모형으로 예측하기


```{r}
library(dplyr)
library(ggplot2)
library(ISLR)
library(MASS)
library(glmnet)
library(randomForest)
library(gbm)
library(rpart)
library(boot)
```

### 1. 데이터 로드와 데이터 구조 파악하기
#### R에 데이터 파일을 읽어 들이고 변수명을 지정하기
 (strip.white = TRUE 옵션은 데이터 파일에서 콤마 다음의 공백문자를 제거한다.)
```{r}
setwd("/Users/jang-eun-a/stat-methods")
adult <- read.csv("adult.data.csv", header = FALSE, strip.white = TRUE)
names(adult) <- c('age', 'workclass', 'fnlwgt', 'education',
                  'education_num', 'merital_status', 'occupation',
                  'relationship', 'race', 'sex', 'capital_gain', 'capital_loss', 
                  'hours_per_week', 'native_country', 'wage')

```


그리고 glimpse() 명령으로 데이터 구조를 살펴보자
```{r}
glimpse(adult)
```
분석 목표는 다른 변수들을 사용해 마지막 변수 wage를 예측하는것 

```{r}
summary(adult)
```
데이터 구조 파악 결과 절반 정도의 설명변수는 범주형 변수임을 알 수 있다.

반응변수의 변수형 알아보기
: factor 타입으로 "<=50k"와 ">50k"의 레벨을 가지고 있으며 각 레벨은 내부적으로 수치값 1과 2에 대응한다.
```{r}
levels(adult$wage)
```

### 2. 훈련, 검증, 테스트세트로 분할
60:20:20

```{r}
set.seed(1002)
n <- nrow(adult)
idx <- 1:n
training_idx <- sample(idx, n * .60)
idx <- setdiff(idx, training_idx)
validate_idx = sample(idx, n * .20)
test_idx <- setdiff(idx, validate_idx)
length(training_idx)
length(validate_idx)
length(test_idx)
training <- adult[training_idx, ]
validation <- adult[validate_idx, ]
test <- adult[test_idx, ]
```

### 3. 시각화로 데이터 탐색하기 EDA
#### 1) 나이(age)와 중산층 여부(wage)의 관계
```{r}
training %>%
  ggplot(aes(age, fill=wage)) +
  geom_density(alpha=.5)
```
- 20 ~ 25세 사이에는 거의 중산층인 사람들이 없다. 
- 파란 영역(중산층)은 25세 이훼 꾸준히 증가하여 30대 초반에는 반 이상의 사람이 중산층 이상의 수입을 얻는 것을 볼 수 있다. 이후엔 점점 감소하는 추세.
- 즉, 중산층 이상의 수입 여부와 나이의 관계는 선형적이지 않다.

#### 2) 인종, 성별, 나이 세 변수와 중산층 여부의 관계
```{r}
training %>%
  filter(race %in% c('Black','White')) %>%
  ggplot(aes(age, fill=wage)) +
  geom_density(alpha = .5) +
  ylim(0, 0.1) +
  facet_grid(race ~ sex, scales = 'free_y')
```
- 나이-중산층 여부의 관계가 남성인 경우에 흑인이나 백인이나 유사하다.
- 하지만 여성일 경우, 흑인의 경우 중장년층에서만 중산층의 비율이 높고 노년층의 경우에는 대부분 소득이 낮은 것을 볼 수 있다.
- 백인 여성의 경우는 28~70세 동안에 >50k 비율이 높지만, 흑인 여성의 경우에는 그 연령대가 32~55세 정도에 불과하다.

#### 3) 총 교육기간과 중산층 여부의 관계 
```{r}
training %>%
  ggplot(aes(education_num, fill=wage)) +
  geom_bar()
```
당연한 결과로 education_num이 증가할수록 중산층 비율이 높아짐을 확인할 수 있다.

### 4. 모형적합 - 로지스틱 회귀
모든 설명변수를 사용해서 로지스틱 회귀 모형에 넣어본다.
```{r}
ad_glm_full <- glm(wage ~ . , data=training, family = binomial)
```
여기서 경고 메세지가 뜨는 이유 : 일부 설명변수의 조합에서 반응변수가 완벽하게 0이거나 1일 경우가 있기 때문이다.

##### 해결방법

- glmnet 같은 정규화된 모형(regularized model)을 사용한다.
- 모형을 변경한다. 변수선택을 시도한다. 범주형 변수의 경우에는 레벨을 줄여본다.
- 베이지안 분석을 한다. 
- 내버려둔다. 신회구간은 왜곡되지만 모형 자체는 쓸만 할 수 있다.

#### 적합된 모형 살펴보기
적합된 모형에서 어떤 변수들이 통계적으로 유의하게 나타나는지를 살펴보자.
```{r}
summary(ad_glm_full)
```
출력 결과에 의하면 다음 변수가 특히 유의미한 것으로 확인된다.

- age
- workclass
- fnlwgt
- education
- occupation
- relationship - wife
- race
등

### 5. glm로지스틱회귀모형으로 예측하기
검증세트에서의 에러확률을 살펴보기.
일단 반응변수와 예측변수를 추출한다.

```{r}
y_obs <- ifelse(validation$wage == ">50K", 1, 0)
yhat_lm <- predict(ad_glm_full, newdata=validation, type='response')
```

```{r}
library(gridExtra)
p1 <- ggplot(data.frame(y_obs, yhat_lm),
             aes(y_obs, yhat_lm, group=y_obs,
                 fill=factor(y_obs))) +
  geom_boxplot()
p2 <- ggplot(data.frame(y_obs, yhat_lm),
             aes(yhat_lm, fill=factor(y_obs))) + 
  geom_density(alpha=.5)
grid.arrange(p1,p2,ncol=2)
```

#### ROC 곡선 그려보기
```{r}
# # install.packages("ROCR")
# library(ROCR)
# pred_lm <- prediction(y_obs, yhat_lm)
# perf_lm <- performance(pred_lm, measure = "tpr", x.measure = "fpr")
# plot(perf_lm, col='black', main="ROC Curve for GLM")
# abline(0,1)
# performance(pred_lm, "auc")@y.values[[1]]
#
#
##Error in UseMethod("predict") : 클래스 "c('double', 'numeric')"의 객체에 적용된 'predict'에 사용할수 있는 메소드가 없습니다
```
위의 에러를 해결하지 못하였다. 
그래서 다른 패키지의 ROC그래프 함수를 사용하였다.
```{r}
# install.packages("Epi")
library(Epi)
a1=ROC(yhat_lm,y_obs, plot="ROC", main="ROC Curve for GLM" )

```



